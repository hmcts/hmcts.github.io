<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>GitOps - HMCTS</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="hmcts.github.io/ways-of-working/new-component/gitops-flux.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="hmcts.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="GitOps - HMCTS" />
      <meta name="twitter:url" content="hmcts.github.io/ways-of-working/new-component/gitops-flux.html" />

      <meta property="og:image" content="hmcts.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="HMCTS" />
      <meta property="og:title" content="GitOps" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="hmcts.github.io/ways-of-working/new-component/gitops-flux.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://github.com/hmcts" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          HMCTS
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
    <div class="govuk-header__content">
      <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
      <nav>
        <ul id="navigation" class="govuk-header__navigation govuk-header__navigation--end" aria-label="Top Level Navigation">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://hmcts-reform.slack.com/app_redirect?channel=rpe">Support</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/hmcts">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="hmcts.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
  <div id="search-results" class="search-results" aria-hidden="true" role="dialog" aria-labelledby="search-results-title">
    <div class="search-results__inner">
      <button class="search-results__close">Close<span class="search-results__close-label"> search results</span></button>
      <h2 id="search-results-title" class="search-results__title" aria-live="assertive" role="alert">Results</h2>
      <div class="search-results__content"></div>
    </div>
  </div>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/"><span>The HMCTS way</span></a>
  </li>
<li><a href="/onboarding/"><span>Platform onboarding</span></a>
<ul>
  <li>
    <a href="/onboarding/team/"><span>Team</span></a>
  </li>
  <li>
    <a href="/onboarding/person/"><span>Person</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/glossary/"><span>Glossary</span></a>
  </li>
<li><a href="/information-security/"><span>Information security</span></a>
<ul>
  <li>
    <a href="/information-security/certificate-automation.html"><span>TLS certificates</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/"><span>Ways of working</span></a>
<ul>
<li><a href="/ways-of-working/standards/"><span>Concepts and standards</span></a>
<ul>
  <li>
    <a href="/ways-of-working/standards/apis.html"><span>API design</span></a>
  </li>
  <li>
    <a href="/ways-of-working/standards/pull-requests.html"><span>Pull requests</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/ways-of-working/principles/"><span>Principles</span></a>
  </li>
<li><a href="/ways-of-working/new-component/"><span>Starting a new component</span></a>
<ul>
  <li>
    <a href="/ways-of-working/new-component/infrastructure-as-code.html"><span>Infrastructure as Code</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/github-repo.html"><span>Create a Github Repository</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/helm-chart.html"><span>Helm chart</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/secrets-management.html"><span>Secrets Management</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/gitops-flux.html"><span>GitOps</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/flux-v1.html"><span>Flux-V1</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/elasticsearch.html"><span>ElasticSearch</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/path-to-live/"><span>Path to live</span></a>
<ul>
  <li>
    <a href="/ways-of-working/path-to-live/public-dns.html"><span>Public DNS</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/tls-certificates.html"><span>TLS certificates</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/shutter.html"><span>Shutter Implementation and Design</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/load-balancer-configuration.html"><span>Load balancer configuration</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/front-door.html"><span>Front Door configuration</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/common-pipeline/"><span>The common pipeline</span></a>
<ul>
  <li>
    <a href="/ways-of-working/common-pipeline/common-pipeline.html"><span>Common pipeline</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/ways-of-working/troubleshooting/"><span>Troubleshooting issues</span></a>
  </li>
  <li>
    <a href="/ways-of-working/asking-for-help/"><span>Asking for help</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/api-docs/"><span>API Documentation</span></a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="gitops">GitOps</h1>
<p>One of our principles being <b>Everything as Code</b>, we practise <a href="https://www.weave.works/technologies/gitops/">Gitops</a> for application deployment to Kubernetes.</p>

<ul>
<li>Git as single source of truth.</li>
<li>Declarative Infrastructure and Application deployment through pull requests.</li>
</ul>

<blockquote>
<p>Please note SDS and <a href="https://github.com/hmcts/cnp-flux-config#migration-status">few clusters of CFT</a> are still on v1, refer <a href="/ways-of-working/new-component/flux-v1.html">V1 docs</a>.</p>
</blockquote>
<h2 id="flux">Flux</h2>
<p><a href="https://docs.fluxcd.io/">Flux</a> is a tool that automatically ensures that the state of a cluster matches the config in <a href="https://github.com/hmcts/cnp-flux-config">Git</a>.</p>

<ul>
<li>Flux uses Gitops Toolkit, a set of APIs and controllers that make up the runtime for Flux.</li>
<li>GOTK (Gitops Toolkit) has 6 main controllers with a specific function to each.</li>
</ul>
<h3 id="source-controller">Source Controller</h3>

<ul>
<li>A common interface for all other components to download from  sources like Git, Helm repository.</li>
<li>Makes source code available as artifacts for other controllers.</li>
</ul>
<h3 id="kustomize-controller">Kustomize Controller</h3>

<ul>
<li>Reconciles the cluster state from multiple sources (provided by source-controller).</li>
<li>It is the main operator which applies all manifests to cluster.</li>
<li>Generates manifests with Kustomize (from plain Kubernetes yamls or Kustomize overlays).</li>
</ul>
<h3 id="helm-controller">Helm Controller</h3>

<ul>
<li>The desired state of a Helm release is described through a Kubernetes Custom Resource named <code>HelmRelease</code>. </li>
<li>Based on the creation, mutation or removal of a HelmRelease resource in the cluster, Helm actions are performed by the operator.</li>
</ul>
<h3 id="notification-controller">Notification Controller</h3>

<ul>
<li>Handles events emitted by the GitOps toolkit controllers (source, kustomize, helm) and dispatches them to external systems (Slack, Microsoft Teams, Discord, Rocker) based on event severity and involved objects.</li>
<li>Can handle events coming from external systems (GitHub, GitLab, Bitbucket, Harbor, Jenkins, etc) and notifies the GitOps toolkit controllers about source changes.</li>
</ul>
<h3 id="image-reflector-controller">Image reflector controller</h3>

<ul>
<li>Scans image repositories and reflects the image metadata in Kubernetes resources.</li>
</ul>
<h3 id="image-automation-controller">Image automation controller</h3>

<ul>
<li>Updates YAML files based on the latest images scanned, and commits the changes to a given Git repository.</li>
</ul>
<h2 id="application-config-in-flux">Application config in flux</h2>

<ol>
<li>See <a href="https://github.com/hmcts/cnp-flux-config#adding-an-app-to-flux">Application Configuration</a> on how to configure and manage your application deployment in various environments.</li>
<li><p><code>HelmRelease</code> should refer to the charts automatically published to <a href="https://github.com/hmcts/hmcts-charts">hmcts-charts repository</a> by <a href="/ways-of-working/new-component/helm-chart.html#jenkins">Jenkins</a>. e.g.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>chart:
spec:
  chart: ./stable/plum-recipe-backend
  sourceRef:
    kind: GitRepository
    name: hmcts-charts
    namespace: flux-system
</code></pre></div></li>
<li><p>Flux configuration should be light, values should be templated within application&rsquo;s chart wherever possible to avoid duplication in each environment. Use <code>{{ .Values.global.environment }}</code> to refer to the environment in your chart.</p></li>
<li><p>Image automation controller would automatically detect latest images published to ACR and upgrade Helm Release on cluster while committing the change to Git.</p></li>
<li><p><b>To avoid issues</b>, please note that any chart configuration (Environment variables) needed for application needs to be published and updated to Flux config before merging the application code that uses the new config. The change should always be non-breaking.</p></li>
<li><p>Make sure you follow <a href="https://github.com/hmcts/cnp-flux-config/blob/master/CODEOWNERS.md#codeowners-guidelines">codeowners guidelines</a> on the repo.</p></li>
</ol>
<h2 id="troubleshooting-issues">Troubleshooting issues</h2>
<p>See <a href="../troubleshooting/">troubleshooting section</a></p>

              <div data-module='page-expiry' data-last-reviewed-on="2022-03-27">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 27 September 2021.

        It needs to be reviewed again on 27 March 2022
.
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 27 March 2022.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/hmcts/hmcts.github.io/blob/source/source/ways-of-working/new-component/gitops-flux.html.md.erb">View source</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io/issues/new?labels=bug&amp;title=Re:%20'GitOps'&amp;body=Problem%20with%20'GitOps'%20(hmcts.github.io/ways-of-working/new-component/gitops-flux.html)">Report problem</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-170132988-1', 'auto');
  ga('set', 'anonymizeIp', true);
  ga('set', 'displayFeaturesTask', null);
  ga('set', 'transport', 'beacon');
  ga('set', 'page', location.pathname+location.search+location.hash);
  ga('send', 'pageview');
  </script>

    <script src="/javascripts/application.js"></script>
  </body>
</html>
