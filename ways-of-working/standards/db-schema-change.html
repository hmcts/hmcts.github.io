<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Making a database schema change - HMCTS</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://hmcts.github.io/ways-of-working/standards/db-schema-change.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="hmcts.github.io" />
      <meta name="twitter:image" content="https://hmcts.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Making a database schema change - HMCTS" />
      <meta name="twitter:url" content="https://hmcts.github.io/ways-of-working/standards/db-schema-change.html" />

      <meta property="og:image" content="https://hmcts.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="HMCTS" />
      <meta property="og:title" content="Making a database schema change" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://hmcts.github.io/ways-of-working/standards/db-schema-change.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://github.com/hmcts" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          HMCTS
        </span>
      </a>
        <strong class="govuk-tag">Live</strong>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://hmcts-reform.slack.com/app_redirect?channel=platops-help">Support</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/hmcts">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://hmcts.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="/"><span>The HMCTS way</span></a>
  </li>
  <li>
    <a href="/glossary/"><span>Glossary</span></a>
  </li>
<li><a href="/onboarding/"><span>Platform onboarding</span></a>
<ul>
<li><a href="/onboarding/team/"><span>Team</span></a>
<ul>
  <li>
    <a href="/onboarding/team/slack.html"><span>Slack</span></a>
  </li>
  <li>
    <a href="/onboarding/team/github.html"><span>GitHub</span></a>
  </li>
  <li>
    <a href="/onboarding/team/office365.html"><span>Office 365</span></a>
  </li>
  <li>
    <a href="/onboarding/team/jenkins.html"><span>Jenkins</span></a>
  </li>
  <li>
    <a href="/onboarding/team/azuread.html"><span>Azure AD</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/onboarding/person/"><span>Person</span></a>
  </li>
</ul>
</li>
<li><a href="/information-security/"><span>Information security</span></a>
<ul>
  <li>
    <a href="/information-security/certificate-automation.html"><span>TLS certificates</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/"><span>Ways of working</span></a>
<ul>
  <li>
    <a href="/ways-of-working/principles/"><span>Principles</span></a>
  </li>
<li><a href="/ways-of-working/standards/"><span>Concepts and standards</span></a>
<ul>
  <li>
    <a href="/ways-of-working/standards/db-schema-change.html"><span>Making a database schema change</span></a>
  </li>
  <li>
    <a href="/ways-of-working/standards/pull-requests.html"><span>Pull requests</span></a>
  </li>
  <li>
    <a href="/ways-of-working/standards/apis.html"><span>API design</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/common-pipeline/"><span>The common pipeline</span></a>
<ul>
<li><a href="/ways-of-working/common-pipeline/publishing-libraries/"><span>Publishing Libraries</span></a>
<ul>
  <li>
    <a href="/ways-of-working/common-pipeline/publishing-libraries/java.html"><span>Java</span></a>
  </li>
  <li>
    <a href="/ways-of-working/common-pipeline/publishing-libraries/nodejs.html"><span>Node.js</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/ways-of-working/common-pipeline/tips_and_tricks.html"><span>Tips and Tricks</span></a>
  </li>
  <li>
    <a href="/ways-of-working/common-pipeline/common-pipeline.html"><span>Common pipeline</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/new-component/"><span>Starting a new component</span></a>
<ul>
  <li>
    <a href="/ways-of-working/new-component/infrastructure-as-code.html"><span>Infrastructure as Code</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/github-repo.html"><span>Create a Github Repository</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/helm-chart.html"><span>Helm chart</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/secrets-management.html"><span>Secrets Management</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/gitops-flux.html"><span>GitOps</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/flux-v1.html"><span>Flux V1</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/elasticsearch.html"><span>ElasticSearch</span></a>
  </li>
  <li>
    <a href="/ways-of-working/new-component/feature-flags.html"><span>Feature flags</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/path-to-live/"><span>Path to live</span></a>
<ul>
  <li>
    <a href="/ways-of-working/path-to-live/load-balancer-configuration.html"><span>Load balancer configuration</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/tls-certificates.html"><span>TLS certificates</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/public-dns.html"><span>Public DNS</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/front-door.html"><span>Front Door configuration</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/shutter.html"><span>Shutter Implementation and Design</span></a>
  </li>
  <li>
    <a href="/ways-of-working/path-to-live/oat.html"><span>Operational Acceptance Testing</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/guides/"><span>Guides</span></a>
<ul>
  <li>
    <a href="/ways-of-working/guides/managing-manual-key-vault-secrets.html"><span>Managing Manual Key Vault Secrets</span></a>
  </li>
  <li>
    <a href="/ways-of-working/guides/flyway-database-migrations.html"><span>Flyway database migration</span></a>
  </li>
  <li>
    <a href="/ways-of-working/guides/creating-a-new-subscription.html"><span>Creating a new subscription</span></a>
  </li>
  <li>
    <a href="/ways-of-working/guides/profile-java-app-in-aks.html"><span>Profile a Java application running in an AKS cluster</span></a>
  </li>
  <li>
    <a href="/ways-of-working/guides/connect-via-vpn.html"><span>Make a new Virtual Network accessible over the VPN</span></a>
  </li>
  <li>
    <a href="/ways-of-working/guides/afd-waf.html"><span>Azure Frontdoor Web Application Firewall Debug</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/environments/"><span>Environments</span></a>
<ul>
  <li>
    <a href="/ways-of-working/environments/external-access-in-demo.html"><span>External Access in Demo</span></a>
  </li>
  <li>
    <a href="/ways-of-working/environments/external-ip-addresses.html"><span>External IP addresses (Egress)</span></a>
  </li>
</ul>
</li>
<li><a href="/ways-of-working/troubleshooting/"><span>Troubleshooting issues</span></a>
<ul>
  <li>
    <a href="/ways-of-working/troubleshooting/fluxV1.html"><span>Flux V1</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/ways-of-working/asking-for-help/"><span>Asking for help</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="/api-docs/"><span>API Documentation</span></a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="making-a-database-schema-change">Making a database schema change</h1>
<p>See <a href="/ways-of-working/guides/flyway-database-migrations.html">Flyway database migration</a> for automatically running schema changes via pipeline.</p>
<p>Adopting a Continuous Delivery (CD) pipeline and zero-downtime deployments brings challenges, particularly regarding evolution of underlying database schemas.</p>
<p>From Chapter 12 Managing Data, Continuous Delivery [David Farley; Jez Humble]:</p>

<blockquote>
<p>The lifecycle of application data differs from that of other parts of the system.
Application data needs to be preserved—indeed, data usually outlasts the applications that were used to create and access it.
Crucially, data needs to be preserved and migrated during new deployments or rollbacks of a system.
In most cases, when we deploy new code, we can erase the previous version and wholly replace it with a new copy.
In this way we can be certain of our starting position.
While that option is possible for data in a few limited cases, for most real-world systems this approach is impossible.
Once a system has been released into production, the data associated with it will grow, and it will have significant value in its own right.
Indeed, arguably it is the most valuable part of your system. This presents problems when we need to modify either the structure or the content.
The underlying problem here is that we can&rsquo;t just swap a new version of the database for an old version, like we would with blue/green deployments for code, if the data in question is constantly in motion.</p>
</blockquote>
<h2 id="what-is-zero-downtime-deployment">What is zero-downtime deployment?</h2>
<p>First, we need to define what zero-downtime actually means.
Does it just apply to frontend services? Is it just public-facing frontend services?
To perform zero-downtime deployments of frontend applications there are two options:</p>

<ul>
<li>If possible, decouple frontend and backend so that frontend still provides a useful service if one of the backends is down</li>
<li>Decouple database schema changes from backend deployment and perform changes in multiple, backward-compatible steps</li>
</ul>
<p><a href="/images/standard-application-stack.png" rel="noopener noreferrer"><img src="/images/standard-application-stack.png" alt="Standard application stack" /></a></p>
<p>Can the frontend tolerate downtime of backend services?
Can the frontend offer reduced functionality when backends are down but still provide a useful service to users?
Is the backend &lsquo;private&rsquo; so that it is only accessible to frontend services? If so, then it is possible to perform zero-downtime deploys by taking the backend services down for a short time to perform DB upgrades.
This enables &lsquo;traditional&rsquo; database migration deployments.
Note, however, that if a backend doesn&rsquo;t support zero-downtime deployments then it must be clearly documented so that any new consuming service knows to be appropriately decoupled.</p>
<p>If the frontend doesn&rsquo;t function without the backend or the &lsquo;backend&rsquo; is also a public-facing service (API) then the backend must also support zero-downtime deployments.
If the backend is backed by a defined-schema datastore e.g. an RDBMS then extra steps need to be added to the release pipeline in order to facilitate this.</p>
<h2 id="zero-downtime-database-deployments">Zero-downtime database deployments</h2>
<p>To perform zero-downtime database deployments the schema migration MUST be separated from the code deployment.
<a href="https://www.brunton-spall.co.uk/post/2014/05/06/database-migrations-done-right/">Database Migrations Done Right</a> explains further and gives an example of the steps required when adding a non-nullable column to an existing table.
Essentially, database migrations must be performed in such a way that they are done independently of application deployments.</p>
<p>The underlying principle to obey here is:</p>
<p><b>Every change you make must be backward compatible with the rest of the system</b></p>
<p>For the add non-nullable column scenario these are the backward compatible steps to perform the change:</p>

<ol>
<li>Add nullable column to database – System keeps adding rows, nulls are fine, reads ignore the null</li>
<li>Code change to write correct value to new rows, and handle reading unexpected nulls – Database doesn’t change, now we have some null rows and some rows with data</li>
<li>Run data migration to fill the other columns – This might be a script, or a bit of code in the application, either way your app doesn’t care about any row, it handles data and nulls just fine</li>
<li>Add the non-null constraint – The database now has no nulls and your new code is writing the correct data.</li>
<li>Remove the code that handles the null case – it won’t happen anymore.</li>
</ol>
<p><a href="/images/zero-downtime-db-migrations.png" rel="noopener noreferrer"><img src="/images/zero-downtime-db-migrations.png" alt="Zero downtime" /></a></p>
<h2 id="strategies-for-refactoring-databases">Strategies for refactoring databases</h2>
<p>These 2 articles give some ideas on what to do and what to avoid when refactoring your database on production systems:</p>
<p><a href="https://medium.com/preply-engineering/postgresql-schema-change-gotchas-bf904e2d5bb7">PostgreSQL schema-change gotchas</a></p>
<p><a href="https://medium.com/paypal-tech/postgresql-at-scale-database-schema-changes-without-downtime-20d3749ed680">Database schema changes without downtime</a></p>
<p>Here are some strategies on how to break down large database changes into less risky steps:</p>

<ul>
<li>Smaller changes are easier to apply</li>
<li>Uniquely identify individual refactorings</li>
<li>Implement a large change by many small ones</li>
<li>Have a database configuration table</li>
<li>Prefer triggers over views or batch synchronization</li>
<li>Choose a sufficient deprecation period</li>
<li>Simplify your database change control board (CCB) strategy</li>
<li>Simplify negotiations with other teams</li>
<li>Encapsulate database access</li>
<li>Be able to easily set up a database environment</li>
<li>Do not duplicate SQL</li>
<li>Put database assets under change control</li>
<li>Beware of politics</li>
</ul>

              <div data-module='page-expiry' data-last-reviewed-on="2022-09-17">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 17 March 2022.

        It needs to be reviewed again on 17 September 2022
        by the page owner <a href="https://hmcts-reform.slack.com/messages/platops-build-notices">platops-build-notices</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 17 September 2022
       by the page owner <a href="https://hmcts-reform.slack.com/messages/platops-build-notices">platops-build-notices</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/hmcts/hmcts.github.io/blob/source/source/ways-of-working/standards/db-schema-change.html.md.erb">View source</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io/issues/new?body=Problem+with+%27Making+a+database+schema+change%27+%28https%3A%2F%2Fhmcts.github.io%2Fways-of-working%2Fstandards%2Fdb-schema-change.html%29&amp;labels=bug&amp;title=Re%3A+%27Making+a+database+schema+change%27">Report problem</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-170132988-1', 'auto');
  ga('set', 'anonymizeIp', true);
  ga('set', 'displayFeaturesTask', null);
  ga('set', 'transport', 'beacon');
  ga('set', 'page', location.pathname+location.search+location.hash);
  ga('send', 'pageview');
  </script>

    <script src="/javascripts/application.js"></script>
  </body>
</html>
