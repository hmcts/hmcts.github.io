<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Infrastructure as Code - HMCTS</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://hmcts.github.io/cloud-native-platform/new-component/infrastructure-as-code.html">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="hmcts.github.io" />
      <meta name="twitter:image" content="https://hmcts.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Infrastructure as Code - HMCTS" />
      <meta name="twitter:url" content="https://hmcts.github.io/cloud-native-platform/new-component/infrastructure-as-code.html" />

      <meta property="og:image" content="https://hmcts.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="HMCTS" />
      <meta property="og:title" content="Infrastructure as Code" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://hmcts.github.io/cloud-native-platform/new-component/infrastructure-as-code.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://github.com/hmcts" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          HMCTS
        </span>
      </a>
        <strong class="govuk-tag">Live</strong>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide menu">Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://hmcts-dts.slack.com/app_redirect?channel=platops-help">Support</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/">Documentation</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="https://github.com/hmcts">GitHub</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://hmcts.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="../../index.html"><span>The HMCTS way</span></a>
  </li>
  <li>
    <a href="../../hmcts-overview/index.html"><span>HMCTS overview</span></a>
  </li>
<li><a href="../../cloud-native-platform/index.html"><span>Cloud Native Platform</span></a>
<ul>
<li><a href="../../cloud-native-platform/onboarding/index.html"><span>Onboarding</span></a>
<ul>
<li><a href="../../cloud-native-platform/onboarding/team/index.html"><span>Team</span></a>
<ul>
</ul>
</li>
  <li>
    <a href="../../cloud-native-platform/onboarding/person/index.html"><span>Person</span></a>
  </li>
</ul>
</li>
<li><a href="../../cloud-native-platform/standards/index.html"><span>Concepts and standards</span></a>
<ul>
</ul>
</li>
<li><a href="../../cloud-native-platform/environments/index.html"><span>Environments</span></a>
<ul>
  <li>
    <a href="../../cloud-native-platform/environments/sandbox-cleardown.html"><span>Sandbox Cleardown</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/environments/aks-auto-shutdown.html"><span>Environment schedule</span></a>
  </li>
</ul>
</li>
<li><a href="../../cloud-native-platform/common-pipeline/index.html"><span>The common pipeline</span></a>
<ul>
  <li>
    <a href="../../cloud-native-platform/common-pipeline/common-pipeline.html"><span>Common pipeline</span></a>
  </li>
<li><a href="../../cloud-native-platform/common-pipeline/publishing-libraries/index.html"><span>Publishing libraries</span></a>
<ul>
</ul>
</li>
</ul>
</li>
<li><a href="../../cloud-native-platform/new-component/index.html"><span>Starting a new component</span></a>
<ul>
  <li>
    <a href="../../cloud-native-platform/new-component/github-repo.html"><span>Create a Github Repository</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/infrastructure-as-code.html"><span>Infrastructure as Code</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/helm-chart.html"><span>Helm chart</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/secrets-management.html"><span>Secrets Management</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/gitops-flux.html"><span>GitOps</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/elasticsearch.html"><span>ElasticSearch</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/new-component/feature-flags.html"><span>Feature flags</span></a>
  </li>
</ul>
</li>
<li><a href="../../cloud-native-platform/path-to-live/index.html"><span>Path to live</span></a>
<ul>
  <li>
    <a href="../../cloud-native-platform/path-to-live/load-balancer-configuration.html"><span>Load balancer configuration</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/path-to-live/tls-certificates.html"><span>TLS certificates</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/path-to-live/public-dns.html"><span>Public DNS</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/path-to-live/front-door.html"><span>Front Door configuration</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/path-to-live/shutter.html"><span>Shutter Implementation and Design</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/path-to-live/oat.html"><span>Operational Acceptance Testing</span></a>
  </li>
</ul>
</li>
<li><a href="../../cloud-native-platform/guides/index.html"><span>Guides</span></a>
<ul>
</ul>
</li>
  <li>
    <a href="../../cloud-native-platform/glossary/index.html"><span>Glossary</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/troubleshooting/index.html"><span>Troubleshooting issues</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/asking-for-help/index.html"><span>Asking for help</span></a>
  </li>
  <li>
    <a href="../../cloud-native-platform/api-docs/index.html"><span>API Documentation</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="../../cjs-common-platform/index.html"><span>CJS Common Platform</span></a>
  </li>
  <li>
    <a href="../../legacy/index.html"><span>Legacy applications</span></a>
  </li>
<li><a href="../../standards/index.html"><span>Standards</span></a>
<ul>
<li><a href="../../standards/principles/index.html"><span>Principles</span></a>
<ul>
  <li>
    <a href="../../standards/principles/continuous-delivery.html"><span>Continuous delivery</span></a>
  </li>
  <li>
    <a href="../../standards/principles/devops.html"><span>DevOps</span></a>
  </li>
  <li>
    <a href="../../standards/principles/programming.html"><span>Programming</span></a>
  </li>
  <li>
    <a href="../../standards/principles/test.html"><span>Testing</span></a>
  </li>
</ul>
</li>
<li><a href="../../standards/practices/index.html"><span>Practices</span></a>
<ul>
  <li>
    <a href="../../standards/practices/frontend.html"><span>Frontend applications</span></a>
  </li>
  <li>
    <a href="../../standards/practices/backends.html"><span>Backend applications</span></a>
  </li>
  <li>
    <a href="../../standards/practices/apis.html"><span>APIs</span></a>
  </li>
  <li>
    <a href="../../standards/practices/certificates.html"><span>Certificates</span></a>
  </li>
</ul>
</li>
<li><a href="../../standards/standards/index.html"><span>Standards</span></a>
<ul>
  <li>
    <a href="../../standards/standards/angular.html"><span>Angular</span></a>
  </li>
</ul>
</li>
  <li>
    <a href="../../standards/technology-stack/index.html"><span>Technology stack</span></a>
  </li>
</ul>
</li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="infrastructure-as-code">Infrastructure as Code</h1>

<!-- Lots of acronyms all at once, provide examples/explanation here instead of wikipedia? -->
<p>We prefer <a href="https://en.wikipedia.org/wiki/Software_as_a_service">Software as a Service</a> (SaaS)
over <a href="https://en.wikipedia.org/wiki/Platform_as_a_service">Platform as a Service</a> (PaaS)
over <a href="https://en.wikipedia.org/wiki/Infrastructure_as_a_service">Infrastructure as a Service</a> (IaaS).</p>
<p>With this in mind, &ldquo;infrastructure as code&rdquo; refers to:</p>

<ul>
<li>Configuration for SaaS offerings.</li>
<li>Provisioning and configuration of PaaS offerings.</li>
<li>Provisioning and configuration of IaaS devices.</li>
</ul>
<p>All our infrastructure is public cloud-based. We use <a href="https://www.terraform.io/docs/index.html">Terraform</a> to manage infrastructure as code.</p>
<p>Service and common component teams are responsible for defining their own infrastructure for their products and components.</p>
<p>All configuration code is managed under source control in GitHub and should be public as described in the <a href="https://www.gov.uk/service-manual/technology/making-source-code-open-and-reusable">GDS Service Manual</a>.</p>
<p>Sensitive information such as passwords and key pairs should neither be managed by Terraform nor present in GitHub and instead retrieved from a Key Vault. See <a href="../secrets-management">secrets management</a> for more information.</p>
<p>The infrastructure code will be used to provision and configure <strong>one set of infrastructure in each environment</strong>.</p>
<h2 id="infrastructure-levels">Infrastructure levels</h2>
<p>Infrastructure is layered into the following levels:</p>

<ul>
<li>Platform</li>
<li>Product</li>
<li>Component</li>
</ul>
<p>Each level builds on lower levels so, the platform-level infrastructure must be provisioned before the
product-level infrastructure, which in turn must be provisioned before the component-level infrastructure.</p>
<p>In each environment, there will be <strong>exactly one set</strong> of all platform-level infrastructure and <strong>exactly one set</strong> of each of the product and component-level infrastructure configurations.</p>
<p>Taken together, these infrastructure levels fully constitute an application.</p>
<p>The following diagram shows the layers and the types of infrastructure that might be found in a given environment.</p>
<p><img src="../../images/infrastructure-levels.png"/></p>
<h3 id="platform-level-infrastructure">Platform-level infrastructure</h3>
<p>This is the base-level infrastructure you can expect to find in each environment. It&rsquo;s managed by the Platform Operations team.
Service and common component teams can assume that this infrastructure already exists in every environment.</p>
<p>The code is managed in various repositories in GitHub. For some configuration, service and common component teams may need to update
these repositories with their specific values. These updates should be requested in the form of GitHub Pull Requests which can then
be reviewed and approved appropriately. Examples of this can be found in the <a href="../path-to-live">path-to-live documentation</a>.</p>
<h3 id="product-and-component-level-infrastructure">Product- and component-level infrastructure</h3>
<p>These levels of infrastructure are provisioned by service and common component teams. It is often called &ldquo;shared infrastructure&rdquo; and that
is the naming convention that has been adopted for repositories.</p>
<p>There are no hard rules around what infrastructure belongs in product-level or component-level but, in general,
if something can be shared between components within a product then it should belong in the product-level infrastructure.
The diagram above shows the types of things that might exist in each level.</p>
<h4 id="product-level-shared-infrastructure">Product-level (shared) infrastructure</h4>
<p>This is infrastructure provisioned by the product team and is shared between all components within the product.</p>
<p>The infrastructure code must be managed in a GitHub repository. The repository should be named <code>{product}-shared-infrastructure</code>.</p>
<p>Terraform <code>.tf</code> files must be placed in the root of the repository.</p>
<p>The <a href="../common-pipeline">common build pipeline</a> must be used to build the infrastructure.</p>
<h4 id="component-level-infrastructure">Component-level infrastructure</h4>
<p>This is infrastructure provisioned by the product team and is specific to a single component within the product.</p>
<p>The infrastructure code must be managed in the component GitHub repository.</p>
<p>Terraform <code>.tf</code> files must be placed in the <code>/infrastructure</code> directory in the repository.</p>
<p>The <a href="https://github.com/hmcts/draft-store/tree/master/infrastructure">draft-store</a> component is a good example.</p>
<p>The <a href="../common-pipeline">common build pipeline</a> must be used to build the infrastructure.</p>
<h2 id="infrastructure-modules">Infrastructure modules</h2>
<p>For infrastructure resources commonly used by teams, a set of pre-packaged Terraform modules is provided to make it easier to provision them.
These modules provide sensible defaults for many configuration options and also include mandated security settings enabling faster
development.</p>
<p>Some frequently used modules are:</p>

<ul>
<li><a href="https://github.com/hmcts/cnp-module-postgres">Azure Database for Postgres</a></li>
<li><a href="https://github.com/hmcts/cnp-module-key-vault">Azure Key Vault</a></li>
<li><a href="https://github.com/hmcts/cnp-module-redis">Azure Cache for Redis</a></li>
</ul>
<p>A full list of modules can be <a href="https://github.com/hmcts?q=cnp-module">found in GitHub</a>.</p>
<h2 id="whitelisted-infrastructure">Whitelisted infrastructure</h2>
<p>To maintain integrity and security of our environments, service and common component teams may only use
a pre-defined set of Azure resources and Terraform infrastructure modules. The whitelist is managed in <a href="https://github.com/hmcts/cnp-jenkins-config/tree/master/terraform-infra-approvals#terraform--whitelists-folder">a GitHub repository</a>.
It is possible to add addtional whitelisted resources for specific products and components with appropriate approval.</p>
<p>The <a href="../common-pipeline">common build pipeline</a> will enforce the whitelist and will halt with an error if non-approved resources or modules are used.</p>
<h2 id="environment-specific-variables">Environment-specific variables</h2>
<p>The <a href="../common-pipeline">common build pipeline</a> supports environment-specific values for Terraform variables. The values can be defined in files named <code>{environment}.tfvars</code> (e.g. <code>prod.tfvars</code>, <code>sandbox.tfvars</code>) placed alongside your <code>.tf</code> files. The appropropriate <code>.tfvars</code> file will be passed into Terraform when the pipeline builds infrastrucuture.</p>
<p>You do not need to specify the value of the environment variables provided by Jenkins such as <code>env</code> (see below). However you do need to create an empty variable ready to accept the variables Jenkins injects.</p>
<h2 id="environment-variables-provided-by-jenkins">Environment variables provided by Jenkins</h2>
<p>Jenkins will inject a number of variables into your deployments. You do not need to specify their values in the infrastructure code, but you do need to create an empty variable ready to accept them if you want to use them:</p>

<ul>
<li><code>env</code></li>
<li><code>product</code> (name of the product)</li>
<li><code>subscription</code> (applicable Azure subscription)</li>
</ul>
<p>For <a href="https://github.com/hmcts/cnp-module-key-vault">Azure Key Vault</a>, you need to create empty variables for:</p>

<ul>
<li><code>tenant_id</code></li>
<li><code>jenkins_AAD_objectId</code></li>
</ul>
<h2 id="terraform-version">Terraform version</h2>
<p>You must specify what version of terraform you want Jenkins to use with a <code>.terraformversion</code> file in the root directory of your repository. <a href="https://github.com/hmcts/tax-tribunals-shared-infrastructure/blob/master/.terraform-version">Example</a>.</p>
<h2 id="jenkinsfile-cnp">Jenkinsfile_CNP</h2>
<p>You must add a <code>Jenkinsfile_CNP</code> to the root directory of your repository in order to define a build pipeline for it. <a href="https://github.com/hmcts/tax-tribunals-shared-infrastructure/blob/master/Jenkinsfile_CNP">Example</a>.</p>

              <div data-module='page-expiry' data-last-reviewed-on="2023-09-15">
    <div class='page-expiry--not-expired'>
      This page was last reviewed on 15 March 2023.

        It needs to be reviewed again on 15 September 2023
        by the page owner <a href="https://hmcts-reform.slack.com/messages/platops-build-notices">platops-build-notices</a>
        .
    </div>

    <div class='page-expiry--expired'>
      This page was set to be reviewed before 15 September 2023
       by the page owner <a href="https://hmcts-reform.slack.com/messages/platops-build-notices">platops-build-notices</a>.
      This might mean the content is out of date.
    </div>
  </div>

          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/hmcts/hmcts.github.io/blob/source/source/cloud-native-platform/new-component/infrastructure-as-code.html.md.erb">View source</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io/issues/new?body=Problem+with+%27Infrastructure+as+Code%27+%28https%3A%2F%2Fhmcts.github.io%2Fcloud-native-platform%2Fnew-component%2Finfrastructure-as-code.html%29&amp;labels=bug&amp;title=Re%3A+%27Infrastructure+as+Code%27">Report problem</a></li>
                <li><a href="https://github.com/hmcts/hmcts.github.io">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

      <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-170132988-1', 'auto');
  ga('set', 'anonymizeIp', true);
  ga('set', 'displayFeaturesTask', null);
  ga('set', 'transport', 'beacon');
  ga('set', 'page', location.pathname+location.search+location.hash);
  ga('send', 'pageview');
  </script>

    <script src="../../javascripts/application.js"></script>
  </body>
</html>
